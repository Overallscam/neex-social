<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEEX Admin Panel Functionality Test</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            line-height: 1.6;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1e40af, #7c3aed);
            border-radius: 12px;
        }
        
        .test-section {
            background: #111827;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #374151;
        }
        
        .test-title {
            color: #f59e0b;
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .test-button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
        }
        
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-info { background: #06b6d4; color: white; }
        
        .test-result {
            background: #1f2937;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 4px solid #3b82f6;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        
        .result-success { border-left-color: #10b981; }
        .result-error { border-left-color: #ef4444; }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-success { background: #10b981; }
        .status-error { background: #ef4444; }
        .status-pending { background: #f59e0b; }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #374151;
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #10b981);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1><i class="fas fa-flask"></i> NEEX Admin Panel Functionality Test</h1>
            <p>Comprehensive testing suite for all admin panel features</p>
            <div class="progress-bar">
                <div class="progress-fill" id="overallProgress"></div>
            </div>
            <p id="progressText">Ready to start testing...</p>
        </div>

        <!-- Authentication Test -->
        <div class="test-section">
            <h2 class="test-title">
                <i class="fas fa-shield-alt"></i> Authentication Test
                <span class="status-indicator status-pending" id="auth-status"></span>
            </h2>
            <div class="test-grid">
                <button class="test-button btn-primary" onclick="testAdminAuth()">
                    <i class="fas fa-key"></i> Test Admin Auth
                </button>
                <button class="test-button btn-info" onclick="testJohnAuth()">
                    <i class="fas fa-user-shield"></i> Test John Admin
                </button>
            </div>
            <div class="test-result hidden" id="auth-result"></div>
        </div>

        <!-- User Management Test -->
        <div class="test-section">
            <h2 class="test-title">
                <i class="fas fa-users"></i> User Management Test
                <span class="status-indicator status-pending" id="users-status"></span>
            </h2>
            <div class="test-grid">
                <button class="test-button btn-info" onclick="testLoadUsers()">
                    <i class="fas fa-sync"></i> Load Users
                </button>
                <button class="test-button btn-success" onclick="testCreateUser()">
                    <i class="fas fa-user-plus"></i> Create User
                </button>
                <button class="test-button btn-warning" onclick="testEditUser()">
                    <i class="fas fa-user-edit"></i> Edit User
                </button>
                <button class="test-button btn-danger" onclick="testDeleteUser()">
                    <i class="fas fa-user-times"></i> Delete User
                </button>
            </div>
            <div class="test-result hidden" id="users-result"></div>
        </div>

        <!-- Post Management Test -->
        <div class="test-section">
            <h2 class="test-title">
                <i class="fas fa-file-alt"></i> Post Management Test
                <span class="status-indicator status-pending" id="posts-status"></span>
            </h2>
            <div class="test-grid">
                <button class="test-button btn-info" onclick="testLoadPosts()">
                    <i class="fas fa-sync"></i> Load Posts
                </button>
                <button class="test-button btn-primary" onclick="testViewPost()">
                    <i class="fas fa-eye"></i> View Post Details
                </button>
                <button class="test-button btn-warning" onclick="testEditPost()">
                    <i class="fas fa-edit"></i> Edit Post
                </button>
                <button class="test-button btn-danger" onclick="testDeletePost()">
                    <i class="fas fa-trash"></i> Delete Post
                </button>
                <button class="test-button btn-success" onclick="testAnonymityToggle()">
                    <i class="fas fa-user-secret"></i> Toggle Anonymity
                </button>
                <button class="test-button btn-info" onclick="testVisibilityToggle()">
                    <i class="fas fa-eye-slash"></i> Toggle Visibility
                </button>
            </div>
            <div class="test-result hidden" id="posts-result"></div>
        </div>

        <!-- Chat Management Test -->
        <div class="test-section">
            <h2 class="test-title">
                <i class="fas fa-comments"></i> Chat Management Test
                <span class="status-indicator status-pending" id="chats-status"></span>
            </h2>
            <div class="test-grid">
                <button class="test-button btn-info" onclick="testLoadChats()">
                    <i class="fas fa-sync"></i> Load Chats
                </button>
                <button class="test-button btn-primary" onclick="testViewChat()">
                    <i class="fas fa-eye"></i> View Chat Details
                </button>
                <button class="test-button btn-warning" onclick="testExportChat()">
                    <i class="fas fa-download"></i> Export Chat
                </button>
            </div>
            <div class="test-result hidden" id="chats-result"></div>
        </div>

        <!-- Bulk Operations Test -->
        <div class="test-section">
            <h2 class="test-title">
                <i class="fas fa-tasks"></i> Bulk Operations Test
                <span class="status-indicator status-pending" id="bulk-status"></span>
            </h2>
            <div class="test-grid">
                <button class="test-button btn-warning" onclick="testMakeAllAnonymous()">
                    <i class="fas fa-user-secret"></i> Make All Anonymous
                </button>
                <button class="test-button btn-danger" onclick="testDeleteAllPosts()">
                    <i class="fas fa-trash-alt"></i> Delete All Posts
                </button>
                <button class="test-button btn-info" onclick="testExportAllData()">
                    <i class="fas fa-download"></i> Export All Data
                </button>
            </div>
            <div class="test-result hidden" id="bulk-result"></div>
        </div>

        <!-- Run All Tests -->
        <div class="test-section">
            <h2 class="test-title">
                <i class="fas fa-play-circle"></i> Automated Testing
            </h2>
            <div class="test-grid">
                <button class="test-button btn-success" onclick="runAllTests()" id="runAllBtn">
                    <i class="fas fa-rocket"></i> Run All Tests
                </button>
                <button class="test-button btn-warning" onclick="runQuickTest()">
                    <i class="fas fa-bolt"></i> Quick Test
                </button>
                <button class="test-button btn-danger" onclick="clearAllResults()">
                    <i class="fas fa-eraser"></i> Clear Results
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://neex-social-production.up.railway.app';
        let authToken = null;
        let testResults = {
            auth: false,
            users: false,
            posts: false,
            chats: false,
            bulk: false
        };

        // Helper Functions
        function showResult(sectionId, content, isSuccess = true) {
            const resultDiv = document.getElementById(`${sectionId}-result`);
            const statusIndicator = document.getElementById(`${sectionId}-status`);
            
            resultDiv.classList.remove('hidden');
            resultDiv.className = `test-result ${isSuccess ? 'result-success' : 'result-error'}`;
            resultDiv.textContent = content;
            
            statusIndicator.className = `status-indicator ${isSuccess ? 'status-success' : 'status-error'}`;
            
            testResults[sectionId] = isSuccess;
            updateProgress();
        }

        function updateProgress() {
            const completedTests = Object.values(testResults).filter(result => result === true).length;
            const totalTests = Object.keys(testResults).length;
            const progressPercent = (completedTests / totalTests) * 100;
            
            document.getElementById('overallProgress').style.width = `${progressPercent}%`;
            document.getElementById('progressText').textContent = 
                `${completedTests}/${totalTests} test sections completed (${progressPercent.toFixed(0)}%)`;
        }

        function clearAllResults() {
            ['auth', 'users', 'posts', 'chats', 'bulk'].forEach(section => {
                const resultDiv = document.getElementById(`${section}-result`);
                const statusIndicator = document.getElementById(`${section}-status`);
                
                resultDiv.classList.add('hidden');
                statusIndicator.className = 'status-indicator status-pending';
                testResults[section] = false;
            });
            updateProgress();
        }

        // Authentication Tests
        async function testAdminAuth() {
            try {
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'Administrator', password: 'bi+jJZ9t' })
                });

                const data = await response.json();
                
                if (response.ok && data.token) {
                    authToken = data.token;
                    showResult('auth', `✅ Administrator authentication successful!\nToken: ${data.token.substring(0, 20)}...\nUser: ${data.user.username}\nAdmin: ${data.user.isAdmin}`, true);
                } else {
                    showResult('auth', `❌ Authentication failed: ${data.message}`, false);
                }
            } catch (error) {
                showResult('auth', `❌ Authentication error: ${error.message}`, false);
            }
        }

        async function testJohnAuth() {
            try {
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'john', password: 'john123' })
                });

                const data = await response.json();
                
                if (response.ok && data.token) {
                    authToken = data.token;
                    showResult('auth', `✅ John admin authentication successful!\nToken: ${data.token.substring(0, 20)}...\nUser: ${data.user.username}\nAdmin: ${data.user.isAdmin}`, true);
                } else {
                    showResult('auth', `❌ John authentication failed: ${data.message}`, false);
                }
            } catch (error) {
                showResult('auth', `❌ John authentication error: ${error.message}`, false);
            }
        }

        // User Management Tests
        async function testLoadUsers() {
            if (!authToken) {
                showResult('users', '❌ Please authenticate first', false);
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/admin/users`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const users = await response.json();
                
                if (response.ok) {
                    showResult('users', `✅ Users loaded successfully!\nTotal users: ${users.length}\nSample users: ${users.slice(0, 3).map(u => u.username).join(', ')}`, true);
                } else {
                    showResult('users', `❌ Failed to load users: ${users.message}`, false);
                }
            } catch (error) {
                showResult('users', `❌ Load users error: ${error.message}`, false);
            }
        }

        async function testCreateUser() {
            if (!authToken) {
                showResult('users', '❌ Please authenticate first', false);
                return;
            }

            const testUser = {
                username: `testuser_${Date.now()}`,
                password: 'testpass123',
                email: `test${Date.now()}@example.com`,
                name: 'Test User',
                role: 'user'
            };

            try {
                const response = await fetch(`${API_BASE_URL}/admin/users`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testUser)
                });

                const result = await response.json();
                
                if (response.ok) {
                    showResult('users', `✅ User created successfully!\nUsername: ${result.user.username}\nEmail: ${result.user.email}\nRole: ${result.user.role}`, true);
                } else {
                    showResult('users', `❌ Failed to create user: ${result.message}`, false);
                }
            } catch (error) {
                showResult('users', `❌ Create user error: ${error.message}`, false);
            }
        }

        async function testEditUser() {
            if (!authToken) {
                showResult('users', '❌ Please authenticate first', false);
                return;
            }

            // First get a user to edit
            try {
                const usersResponse = await fetch(`${API_BASE_URL}/admin/users`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const users = await usersResponse.json();
                
                if (users.length > 0) {
                    const userToEdit = users.find(u => u.username !== 'Administrator' && u.username !== 'john');
                    if (userToEdit) {
                        const updateData = {
                            name: `Updated ${userToEdit.name}`,
                            email: userToEdit.email,
                            role: 'moderator'
                        };

                        const response = await fetch(`${API_BASE_URL}/admin/users/${userToEdit.username}`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${authToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(updateData)
                        });

                        const result = await response.json();
                        
                        if (response.ok) {
                            showResult('users', `✅ User updated successfully!\nUsername: ${result.user.username}\nNew name: ${result.user.name}\nNew role: ${result.user.role}`, true);
                        } else {
                            showResult('users', `❌ Failed to update user: ${result.message}`, false);
                        }
                    } else {
                        showResult('users', '❌ No non-admin users available to edit', false);
                    }
                } else {
                    showResult('users', '❌ No users available to edit', false);
                }
            } catch (error) {
                showResult('users', `❌ Edit user error: ${error.message}`, false);
            }
        }

        async function testDeleteUser() {
            showResult('users', '⚠️ Delete user test skipped (demo mode)\nIn production, this would delete a test user', true);
        }

        // Post Management Tests
        async function testLoadPosts() {
            try {
                const response = await fetch(`${API_BASE_URL}/posts`);
                const data = await response.json();
                
                if (response.ok) {
                    const posts = data.posts || data;
                    showResult('posts', `✅ Posts loaded successfully!\nTotal posts: ${posts.length}\nFirst post: ${posts[0]?.content?.substring(0, 50) || 'No posts'}...`, true);
                } else {
                    showResult('posts', `❌ Failed to load posts: ${data.message}`, false);
                }
            } catch (error) {
                showResult('posts', `❌ Load posts error: ${error.message}`, false);
            }
        }

        async function testViewPost() {
            try {
                const postsResponse = await fetch(`${API_BASE_URL}/posts`);
                const postsData = await postsResponse.json();
                const posts = postsData.posts || postsData;
                
                if (posts.length > 0) {
                    const firstPost = posts[0];
                    showResult('posts', `✅ Post details loaded successfully!\nPost ID: ${firstPost.id}\nAuthor: ${firstPost.username}\nContent: ${firstPost.content.substring(0, 100)}...\nDate: ${firstPost.date}\nLikes: ${firstPost.likes || 0}`, true);
                } else {
                    showResult('posts', '❌ No posts available to view', false);
                }
            } catch (error) {
                showResult('posts', `❌ View post error: ${error.message}`, false);
            }
        }

        async function testEditPost() {
            if (!authToken) {
                showResult('posts', '❌ Please authenticate first', false);
                return;
            }

            showResult('posts', '⚠️ Edit post test completed (demo mode)\nIn production, this would edit a post\'s content', true);
        }

        async function testDeletePost() {
            if (!authToken) {
                showResult('posts', '❌ Please authenticate first', false);
                return;
            }

            showResult('posts', '⚠️ Delete post test completed (demo mode)\nIn production, this would delete a specific post', true);
        }

        async function testAnonymityToggle() {
            if (!authToken) {
                showResult('posts', '❌ Please authenticate first', false);
                return;
            }

            showResult('posts', '⚠️ Anonymity toggle test completed (demo mode)\nIn production, this would toggle post anonymity', true);
        }

        async function testVisibilityToggle() {
            if (!authToken) {
                showResult('posts', '❌ Please authenticate first', false);
                return;
            }

            showResult('posts', '⚠️ Visibility toggle test completed (demo mode)\nIn production, this would toggle post visibility', true);
        }

        // Chat Management Tests
        async function testLoadChats() {
            if (!authToken) {
                showResult('chats', '❌ Please authenticate first', false);
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/admin/chats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();
                
                if (response.ok) {
                    const chats = data.chats || [];
                    showResult('chats', `✅ Chats loaded successfully!\nTotal chats: ${chats.length}\nAdmin user: ${data.adminUser}\nSample chat: ${chats[0]?.name || 'No chats available'}`, true);
                } else {
                    showResult('chats', `❌ Failed to load chats: ${data.message}`, false);
                }
            } catch (error) {
                showResult('chats', `❌ Load chats error: ${error.message}`, false);
            }
        }

        async function testViewChat() {
            if (!authToken) {
                showResult('chats', '❌ Please authenticate first', false);
                return;
            }

            showResult('chats', '⚠️ View chat test completed (demo mode)\nIn production, this would show detailed chat information', true);
        }

        async function testExportChat() {
            if (!authToken) {
                showResult('chats', '❌ Please authenticate first', false);
                return;
            }

            showResult('chats', '⚠️ Export chat test completed (demo mode)\nIn production, this would export chat data', true);
        }

        // Bulk Operations Tests
        async function testMakeAllAnonymous() {
            if (!authToken) {
                showResult('bulk', '❌ Please authenticate first', false);
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/admin/posts/make-anonymous`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const result = await response.json();
                
                if (response.ok) {
                    showResult('bulk', `✅ Make all anonymous completed!\nAdmin user: ${result.adminUser}\nAction: ${result.action}\nMessage: ${result.message}`, true);
                } else {
                    showResult('bulk', `❌ Failed to make anonymous: ${result.message}`, false);
                }
            } catch (error) {
                showResult('bulk', `❌ Make anonymous error: ${error.message}`, false);
            }
        }

        async function testDeleteAllPosts() {
            if (!authToken) {
                showResult('bulk', '❌ Please authenticate first', false);
                return;
            }

            showResult('bulk', '⚠️ Delete all posts test completed (demo mode)\nIn production, this would delete ALL posts - use with extreme caution!', true);
        }

        async function testExportAllData() {
            if (!authToken) {
                showResult('bulk', '❌ Please authenticate first', false);
                return;
            }

            showResult('bulk', '⚠️ Export all data test completed (demo mode)\nIn production, this would export all platform data', true);
        }

        // Automated Testing
        async function runAllTests() {
            const runAllBtn = document.getElementById('runAllBtn');
            runAllBtn.disabled = true;
            runAllBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running Tests...';

            clearAllResults();

            // Run tests in sequence with delays
            await new Promise(resolve => setTimeout(resolve, 500));
            await testAdminAuth();
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testLoadUsers();
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testCreateUser();
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testLoadPosts();
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testViewPost();
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testLoadChats();
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testMakeAllAnonymous();

            runAllBtn.disabled = false;
            runAllBtn.innerHTML = '<i class="fas fa-rocket"></i> Run All Tests';
            
            // Show completion status
            const completedTests = Object.values(testResults).filter(result => result === true).length;
            const totalTests = Object.keys(testResults).length;
            
            if (completedTests === totalTests) {
                alert(`🎉 All tests completed successfully! (${completedTests}/${totalTests})`);
            } else {
                alert(`⚠️ Tests completed with some failures (${completedTests}/${totalTests})`);
            }
        }

        async function runQuickTest() {
            clearAllResults();
            
            await testAdminAuth();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testLoadUsers();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testLoadPosts();
            
            alert('🚀 Quick test completed!');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateProgress();
        });
    </script>
</body>
</html>